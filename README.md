# üí≥ Payment Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–ª–∞—Ç–µ–∂–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Event Sourcing**.

## üéØ –û –ø—Ä–æ–µ–∫—Ç–µ

–°–µ—Ä–≤–∏—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è ‚Äî –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–∞ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π –ø–ª–∞—Ç–µ–∂–∞ (Event Sourcing)
- ‚úÖ REST API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π (Swagger)
- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (Result type)

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º **Clean Architecture** —Å —è–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏:

```
src/
‚îú‚îÄ‚îÄ domain/           # –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ (Payment –∞–≥—Ä–µ–≥–∞—Ç, –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞)
‚îú‚îÄ‚îÄ application/      # Use cases (–±–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
‚îú‚îÄ‚îÄ infrastructure/   # –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–±—ã—Ç–∏–π (InMemoryEventStore)
‚îú‚îÄ‚îÄ interfaces/       # HTTP API (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
‚îî‚îÄ‚îÄ shared/           # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã (Result type, helpers)
```

### Event Sourcing

–í–º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Å–µ—Ä–≤–∏—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π**:

```
payment_initiated ‚Üí payment_link_generated ‚Üí client_redirected_to_provider ‚Üí payment_succeeded
```

–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `reconstitute()`.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Node.js** 20+
- **pnpm** 8+
- **Docker** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### üê≥ –ó–∞–ø—É—Å–∫ —Å Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª:**

```bash
APP_PORT=3000
PAYMENT_LINK_DOMAIN=https://pay.example.com
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**

```bash
docker-compose up -d
```

3. **–û—Ç–∫—Ä–æ–π—Ç–µ Swagger UI:**

```
http://localhost:3000/swagger
```

4. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞:**

```bash
docker-compose down
```

### üíª –ó–∞–ø—É—Å–∫ –±–µ–∑ Docker

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**

```bash
pnpm install
```

2. **–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª:**

```bash
APP_PORT=3000
PAYMENT_LINK_DOMAIN=https://pay.example.com
```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:**

```bash
pnpm dev
```

4. **Swagger UI:**

```
http://localhost:3000/swagger
```

## üì° API Endpoints

### –ü–ª–∞—Ç–µ–∂–∏

#### `POST /payments`
–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂

**Request:**
```json
{
  "amount": 1000.50,
  "currency": "RUB",
  "description": "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ #12345"
}
```

**Response:**
```json
{
  "paymentId": "550e8400-e29b-41d4-a716-446655440000"
}
```

---

#### `POST /payments/:id/link`
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã

**Response:**
```json
{
  "link": "https://pay.example.com/550e8400-e29b-41d4-a716-446655440000"
}
```

---

#### `GET /payments/:id/history`
–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏–π –ø–ª–∞—Ç–µ–∂–∞

**Response:**
```json
{
  "paymentId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "success",
  "history": [
    {
      "type": "payment_initiated",
      "timestamp": "2024-01-01T12:00:00.000Z",
      "payload": { "amount": 1000.50, "currency": "RUB" }
    },
    {
      "type": "payment_link_generated",
      "timestamp": "2024-01-01T12:00:01.000Z",
      "payload": { "link": "https://pay.example.com/..." }
    }
  ]
}
```

### Webhooks

#### `POST /webhook`
–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**Request:**
```json
{
  "paymentId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "success"
}
```

–í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: `success`, `failed`, `redirected`

## üé¨ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–ª–∞—Ç–µ–∂–∞

```mermaid
graph LR
    A[created] -->|generateLink| B[link_ready]
    B -->|webhook: redirected| C[client_redirected]
    C -->|webhook: success| D[success]
    C -->|webhook: failed| E[failed]
```

1. **–°–æ–∑–¥–∞–Ω–∏–µ** (`POST /payments`) ‚Üí —Å—Ç–∞—Ç—É—Å `created`
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏** (`POST /payments/:id/link`) ‚Üí —Å—Ç–∞—Ç—É—Å `link_ready`
3. **–ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç** (`POST /webhook` —Å `redirected`) ‚Üí —Å—Ç–∞—Ç—É—Å `client_redirected`
4. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ** (`POST /webhook` —Å `success`/`failed`) ‚Üí —Å—Ç–∞—Ç—É—Å `success`/`failed`

## üß™ –¢–µ—Å—Ç—ã

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:

```bash
pnpm test
```

–ü–æ–∫—Ä—ã—Ç–∏–µ:
- ‚úÖ –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤)
- ‚úÖ –ë–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏ (–ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª)
- ‚úÖ Event Sourcing (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–æ–±—ã—Ç–∏–π)

**16 —Ç–µ—Å—Ç–æ–≤** –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Node.js test runner ‚Äî –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Node.js 20** + TypeScript
- **Elysia** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **Swagger** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- **TypeBox** ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º
- **Event Sourcing** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π
- **Result type** ‚Äî —è–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑ exceptions

## üèõÔ∏è –ü—Ä–∏–Ω—Ü–∏–ø—ã –¥–∏–∑–∞–π–Ω–∞

- **Clean Architecture** ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å–ª–æ—ë–≤
- **Event Sourcing** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤–º–µ—Å—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **Domain-Driven Design** ‚Äî –±–æ–≥–∞—Ç–∞—è –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
- **SOLID** ‚Äî –µ–¥–∏–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –∏–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **–Ø–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî Result type –≤–º–µ—Å—Ç–æ try/catch
- **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TypeScript

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏–π

–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:

```typescript
{
  aggregateId: string;      // ID –ø–ª–∞—Ç–µ–∂–∞
  type: EventType;          // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
  timestamp: Date;          // –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
  payload: Record<string, unknown>;  // –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
}
```

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `payment_initiated` | –ü–ª–∞—Ç—ë–∂ —Å–æ–∑–¥–∞–Ω |
| `payment_link_generated` | –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ |
| `client_redirected_to_provider` | –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—à—ë–ª –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É |
| `payment_succeeded` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| `payment_failed` | –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã |
| `payment_expired` | –ü–ª–∞—Ç—ë–∂ –∏—Å—Ç—ë–∫ |


## üöÄ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **in-memory** —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –î–ª—è production –≤–æ–∑–º–æ–∂–Ω–æ:

1. **EventStore** ‚Üí PostgreSQL / EventStoreDB
2. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∑–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º
3. **Message Bus** ‚Üí Kafka / NATS –¥–ª—è —Å–æ–±—ã—Ç–∏–π –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏
4. **Read Models** ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è

–ë–ª–∞–≥–æ–¥–∞—Ä—è Event Sourcing –∏ —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –∑–∞–º–µ–Ω–∞ InMemoryEventStore –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î –ø–æ—Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ –≤ infrastructure-—Å–ª–æ–µ.

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `APP_PORT` | –ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | `3000` |
| `PAYMENT_LINK_DOMAIN` | –î–æ–º–µ–Ω –¥–ª—è —Å—Å—ã–ª–æ–∫ –æ–ø–ª–∞—Ç—ã | `https://pay.example.com` |

## ü§ù –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏:

```
payment-service/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ domain/              # –ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ application/         # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è use cases
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/      # –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/          # HTTP API
‚îÇ   ‚îî‚îÄ‚îÄ shared/              # –£—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ domain/              # –¢–µ—Å—Ç—ã –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ application/         # –¢–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
‚îú‚îÄ‚îÄ configs/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile               # Multi-stage build
‚îî‚îÄ‚îÄ docker-compose.yml       # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
```
